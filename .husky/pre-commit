#!/bin/sh

# Unset npm_config_prefix to avoid compatibility issues with nvm
unset npm_config_prefix

# Try to load nvm and use the version specified in .nvmrc
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
elif [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
  . "/opt/homebrew/opt/nvm/nvm.sh"
elif [ -s "/usr/local/opt/nvm/nvm.sh" ]; then
  . "/usr/local/opt/nvm/nvm.sh"
fi

if command -v nvm >/dev/null 2>&1; then
  nvm use
else
  echo "Warning: nvm not found. Using system node version: $(node -v)"
fi

# If ONLY media, version-related files (package.json, angular.json), husky files, or docs/references are changed, skip everything
if ! git diff --cached --name-only | grep -qvE '\.(jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/|^\.geminiignore$|^docs/references/'; then
  echo "Only media, version, husky, .geminiignore, or docs/references changes detected. Skipping pre-commit hooks."
  exit 0
fi

npx biome check --write --staged --no-errors-on-unmatched
npm run verify-constants
node scripts/check-file-size.js

# Check for broken links in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d | grep -vE '\.(jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/|package-lock\.json$|^\.geminiignore$|^docs/references/|^sources\.json$|^src/app/game-constants\.ts$' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | lychee --files-from -
fi

# Check if any staged files are NOT documentation, media, version-related, husky-related, or docs/references
if git diff --cached --name-only | grep -qvE '\.(md|jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/|^\.geminiignore$|^docs/references/'; then
  # Determine what to run based on changed files
  FRONTEND_CHANGED=false
  BACKEND_CHANGED=false

  # Check for frontend changes (anything outside functions/ excluding pure docs/media/version/husky/references)
  if git diff --cached --name-only | grep -vE '^functions/' | grep -qvE '\.(md|jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/|^package-lock\.json$|^\.geminiignore$|^docs/references/'; then
    FRONTEND_CHANGED=true
  fi

  # Check for backend changes (anything in functions/ excluding lock file)
  if git diff --cached --name-only | grep -E '^functions/' | grep -qvE 'package-lock\.json$'; then
    BACKEND_CHANGED=true
  fi

  if [ "$FRONTEND_CHANGED" = true ]; then
    echo "Frontend changes detected. Running frontend tests and build..."
    npx vitest run --reporter=dot
    ng build --define "import.meta.env.APP_VERSION='$(node scripts/get-version.js)'" --progress=false > /dev/null
  fi

  if [ "$BACKEND_CHANGED" = true ]; then
    echo "Backend changes detected. Running backend tests..."
    npm run test --prefix functions -- --reporter min
  fi
else
  echo "Only media or documentation changes detected. Skipping tests and build."
fi