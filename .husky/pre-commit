#!/bin/sh

# Unset npm_config_prefix to avoid compatibility issues with nvm
unset npm_config_prefix

# Try to load nvm and use the version specified in .nvmrc
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
elif [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
  . "/opt/homebrew/opt/nvm/nvm.sh"
elif [ -s "/usr/local/opt/nvm/nvm.sh" ]; then
  . "/usr/local/opt/nvm/nvm.sh"
fi

if command -v nvm >/dev/null 2>&1; then
  nvm use
else
  echo "Warning: nvm not found. Using system node version: $(node -v)"
fi

# If ONLY media, version-related files (package.json, angular.json), or husky files are changed, skip everything
if ! git diff --cached --name-only | grep -qvE '\.(jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/'; then
  echo "Only media, version changes (package.json, angular.json), or husky changes detected. Skipping pre-commit hooks."
  exit 0
fi

npx biome check --write --staged --no-errors-on-unmatched
node scripts/check-file-size.js

# Check for broken links in staged files
STAGED_FILES=$(git diff --cached --name-only | grep -vE '\.(jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/' || true)
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | lychee --files-from -
fi

# Check if any staged files are NOT documentation, media, version-related, or husky-related
if git diff --cached --name-only | grep -qvE '\.(md|jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/'; then
  # Use concise reporters and suppress stdout for build unless there's an error
  npx vitest run --reporter=dot
  npm run test --prefix functions -- --reporter min
  ng build --define "import.meta.env.APP_VERSION='$(node scripts/get-version.js)'" --progress=false > /dev/null
else
  echo "Only media or documentation changes detected. Skipping tests and build."
fi