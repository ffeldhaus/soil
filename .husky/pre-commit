#!/bin/sh

# Try to load nvm and use the version specified in .nvmrc
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
elif [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
  . "/opt/homebrew/opt/nvm/nvm.sh"
elif [ -s "/usr/local/opt/nvm/nvm.sh" ]; then
  . "/usr/local/opt/nvm/nvm.sh"
fi

if command -v nvm >/dev/null 2>&1; then
  nvm use
else
  echo "Warning: nvm not found. Using system node version: $(node -v)"
fi

# If ONLY media files are changed, skip everything
if ! git diff --cached --name-only | grep -qvE '\.(jpeg|jpg|png|webp|gif|svg|ico)$'; then
  echo "Only media changes detected. Skipping pre-commit hooks."
  exit 0
fi

npx biome check --write --staged --no-errors-on-unmatched
node scripts/check-file-size.js

# Check if any staged files are NOT documentation or media
if git diff --cached --name-only | grep -qvE '\.(md|jpeg|jpg|png|webp|gif|svg|ico)$'; then
  npm run test:unit:coverage
  npm run test:functions
  npm run build
else
  echo "Only media or documentation changes detected. Skipping tests and build."
fi