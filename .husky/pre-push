#!/bin/sh

# Unset npm_config_prefix to avoid compatibility issues with nvm
unset npm_config_prefix

# Try to load nvm and use the version specified in .nvmrc
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
elif [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
  . "/opt/homebrew/opt/nvm/nvm.sh"
elif [ -s "/usr/local/opt/nvm/nvm.sh" ]; then
  . "/usr/local/opt/nvm/nvm.sh"
fi

if command -v nvm >/dev/null 2>&1; then
  nvm use
fi

# Check for outdated packages in frontend (root) and backend (functions)
# Fail if any package's "current" version is behind "wanted" version
check_outdated() {
  DIR=$1
  NAME=$2
  echo "Checking for outdated packages in $NAME..."
  OUTDATED=$(npm outdated --prefix "$DIR" --json)
  if [ -n "$OUTDATED" ] && [ "$OUTDATED" != "{}" ]; then
    # Check if any package has current != wanted
    # We use node to parse the JSON as it is more reliable than grep/sed
    UPDATABLE=$(echo "$OUTDATED" | node -e "
      const data = JSON.parse(require('fs').readFileSync(0, 'utf8'));
      const updatable = Object.entries(data).filter(([name, info]) => info.current !== info.wanted);
      if (updatable.length > 0) {
        console.log('Updatable packages found in $NAME:');
        updatable.forEach(([name, info]) => console.log('  ' + name + ': ' + info.current + ' -> ' + info.wanted));
        process.exit(1);
      }
    ")
    if [ $? -ne 0 ]; then
      echo "$UPDATABLE"
      echo "Error: Please update packages in $NAME according to package.json constraints (npm update) before pushing."
      exit 1
    fi
  fi
}

check_outdated "." "Frontend"
check_outdated "functions" "Backend"

# If we can compare against origin/main, do it. Otherwise just run tests.
if git rev-parse --verify origin/main >/dev/null 2>&1; then
  # If ONLY media, version-related files (package.json, angular.json), or husky files are changed since origin/main, skip everything
  if ! git diff --name-only origin/main..HEAD | grep -qvE '\.(jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/'; then
    echo "Only media, version, or husky changes detected since origin/main. Skipping pre-push hooks."
    exit 0
  fi

  # Check if any files changed since origin/main are NOT media, documentation, version, or husky
  if git diff --name-only origin/main..HEAD | grep -qvE '\.(md|jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/'; then
    npm run test:e2e
  else
    echo "Only media, documentation, version, or husky changes detected since origin/main. Skipping E2E tests."
  fi
else
  # Fallback: if origin/main doesn't exist, always run tests
  npm run test:e2e
fi
