#!/bin/sh

# Unset npm_config_prefix to avoid compatibility issues with nvm
unset npm_config_prefix

# Try to load nvm and use the version specified in .nvmrc
export NVM_DIR="$HOME/.nvm"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  . "$NVM_DIR/nvm.sh"
elif [ -s "/opt/homebrew/opt/nvm/nvm.sh" ]; then
  . "/opt/homebrew/opt/nvm/nvm.sh"
elif [ -s "/usr/local/opt/nvm/nvm.sh" ]; then
  . "/usr/local/opt/nvm/nvm.sh"
fi

if command -v nvm >/dev/null 2>&1; then
  nvm use
fi

# Check for outdated packages in frontend (root) and backend (functions)
# Fail if any package's "current" version is behind "wanted" version
check_outdated() {
  DIR=$1
  NAME=$2
  echo "Checking for outdated packages in $NAME..."
  OUTDATED=$(npm outdated --prefix "$DIR" --json || true)
  if [ -z "$OUTDATED" ] || [ "$OUTDATED" = "{}" ]; then
    echo "No outdated packages in $NAME."
    return 0
  fi
  
  # Check if any package has current != wanted
  # We use node to parse the JSON as it is more reliable than grep/sed
  UPDATABLE_INFO=$(echo "$OUTDATED" | node -e "
    try {
      const data = JSON.parse(require('fs').readFileSync(0, 'utf8'));
      const updatable = Object.entries(data).filter(([name, info]) => info.current !== info.wanted);
      if (updatable.length > 0) {
        console.log('Updatable packages found in $NAME:');
        updatable.forEach(([name, info]) => console.log('  ' + name + ': ' + info.current + ' -> ' + info.wanted));
        process.exit(1);
      }
    } catch (e) {
      // If parsing fails (e.g. not JSON), assume no updatable packages or log error
      process.exit(0);
    }
  ")
  EXIT_CODE=$?
  if [ $EXIT_CODE -ne 0 ]; then
    echo "$UPDATABLE_INFO"
    echo "Error: Please update packages in $NAME according to package.json constraints (npm update) before pushing."
    exit 1
  fi
  echo "All packages in $NAME are up to date within constraints."
}

check_outdated "." "Frontend"
check_outdated "functions" "Backend"

# Check if anything relevant changed
if git rev-parse --verify origin/main >/dev/null 2>&1; then
  # If ONLY media, version-related files (package.json, angular.json), husky files, or docs/references are changed since origin/main, skip everything
  if ! git diff --name-only origin/main..HEAD | grep -qvE '\.(jpeg|jpg|png|webp|gif|svg|ico)$|^package\.json$|^angular\.json$|^\.husky/|^\.geminiignore$|^docs/references/'; then
    echo "Only media, version, husky, .geminiignore, or docs/references changes detected since origin/main. Skipping pre-push hooks."
    exit 0
  fi
fi

echo "Pre-push checks passed."
