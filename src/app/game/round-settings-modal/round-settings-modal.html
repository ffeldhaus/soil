<div
  class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
  (click)="settingsCancelled.emit()"
>
  <div
    class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl p-6 max-w-lg w-full"
    (click)="$event.stopPropagation()"
  >
    <h2 class="text-2xl font-bold text-white mb-6 font-serif">{{ t('settings.title') }}</h2>

    <div class="space-y-6">
      <!-- Machines Slider -->
      <div class="space-y-2">
        <div class="flex justify-between">
          <label class="text-gray-300 font-medium">{{ t('settings.machines') }}</label>
          <span class="text-emerald-400 font-bold">{{ settings.machines }}</span>
        </div>
        <input
          type="range"
          min="0"
          max="4"
          step="1"
          [(ngModel)]="settings.machines"
          class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
        />
        <p class="text-xs text-gray-400">{{ t('settings.machines_desc') }}</p>
      </div>

      <!-- Toggles Grid -->
      <div class="grid grid-cols-1 gap-4">
        <!-- Organic -->
        <label class="flex items-center space-x-3 cursor-pointer group">
          <input
            type="checkbox"
            [(ngModel)]="settings.organic"
            class="form-checkbox w-5 h-5 text-emerald-500 rounded border-gray-600 bg-gray-800 focus:ring-emerald-500 focus:ring-offset-gray-900"
          />
          <div>
            <span class="text-gray-300 font-medium group-hover:text-white transition-colors">{{
              t('settings.organic')
            }}</span>
            <p class="text-xs text-gray-500">{{ t('settings.organic_desc') }}</p>
          </div>
        </label>

        <!-- Fertilizer -->
        <label class="flex items-center space-x-3 cursor-pointer group" [class.opacity-50]="settings.organic">
          <input
            type="checkbox"
            [(ngModel)]="settings.fertilizer"
            [disabled]="settings.organic"
            class="form-checkbox w-5 h-5 text-emerald-500 rounded border-gray-600 bg-gray-800 focus:ring-emerald-500 focus:ring-offset-gray-900"
          />
          <div>
            <span class="text-gray-300 font-medium group-hover:text-white transition-colors">{{
              t('settings.fertilizer')
            }}</span>
            <p class="text-xs text-gray-500">{{ t('settings.fertilizer_desc') }}</p>
          </div>
        </label>

        <!-- Pesticide -->
        <label class="flex items-center space-x-3 cursor-pointer group" [class.opacity-50]="settings.organic">
          <input
            type="checkbox"
            [(ngModel)]="settings.pesticide"
            [disabled]="settings.organic"
            class="form-checkbox w-5 h-5 text-emerald-500 rounded border-gray-600 bg-gray-800 focus:ring-emerald-500 focus:ring-offset-gray-900"
          />
          <div>
            <span class="text-gray-300 font-medium group-hover:text-white transition-colors">{{
              t('settings.pesticide')
            }}</span>
            <p class="text-xs text-gray-500">{{ t('settings.pesticide_desc') }}</p>
          </div>
        </label>

        <!-- Organisms (Beneficial) -->
        <label class="flex items-center space-x-3 cursor-pointer group">
          <input
            type="checkbox"
            [(ngModel)]="settings.organisms"
            class="form-checkbox w-5 h-5 text-emerald-500 rounded border-gray-600 bg-gray-800 focus:ring-emerald-500 focus:ring-offset-gray-900"
          />
          <div>
            <span class="text-gray-300 font-medium group-hover:text-white transition-colors">{{
              t('settings.organisms')
            }}</span>
            <p class="text-xs text-gray-500">{{ t('settings.organisms_desc') }}</p>
          </div>
        </label>
      </div>

      <!-- Price Fixing (Only if advanced pricing is enabled) -->
      @if (config?.advancedPricingEnabled && plantedCrops.length > 0) {
        <div class="mt-6 pt-6 border-t border-gray-800 space-y-4">
          <div>
            <span class="text-amber-400 font-bold text-sm uppercase tracking-wider">{{ t('settings.priceFixing') }}</span>
            <p class="text-xs text-gray-400 mt-1">{{ t('settings.priceFixing_desc') }}</p>
          </div>
          <div class="grid grid-cols-2 gap-2">
            @for (crop of plantedCrops; track crop) {
              <button
                (click)="togglePriceFixing(crop)"
                class="flex items-center justify-between px-3 py-2 rounded-lg border transition-all text-sm"
                [class]="{
                  'bg-amber-900/30': isPriceFixed(crop),
                  'border-amber-500/50': isPriceFixed(crop),
                  'text-amber-200': isPriceFixed(crop),
                  'bg-gray-800/50': !isPriceFixed(crop),
                  'border-gray-700': !isPriceFixed(crop),
                  'text-gray-400': !isPriceFixed(crop)
                }"
              >
                <span>{{ getCropName(crop) }}</span>
                @if (isPriceFixed(crop)) {
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                }
              </button>
            }
          </div>
        </div>
      }
    </div>

    <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-800">
      <button (click)="settingsCancelled.emit()" class="px-4 py-2 text-gray-400 hover:text-white transition">
        {{ t('settings.cancel') }}
      </button>
      <button
        (click)="submit()"
        data-testid="confirm-round-settings"
        class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium transition shadow-lg shadow-emerald-900/20"
      >
        {{ t('settings.confirm') }}
      </button>
    </div>
  </div>
</div>
