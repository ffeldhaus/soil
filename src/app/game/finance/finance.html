<div class="w-full px-4 md:px-8 pt-4 pb-12 min-h-full">
  <div class="max-w-7xl mx-auto space-y-12">
    <!-- Header -->
    <div class="bg-gray-900 border border-gray-800 rounded-[2rem] p-8 md:p-10 shadow-2xl relative overflow-hidden group">
      <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500/5 blur-3xl -mr-32 -mt-32"></div>
      <div class="relative z-10">
        <h2
          class="text-4xl md:text-5xl font-black text-white font-serif tracking-tight">Finanzbericht</h2>
        <p
          class="text-gray-400 mt-4 text-sm md:text-base max-w-2xl leading-relaxed">
          Detaillierte Analyse Ihrer landwirtschaftlichen Leistung in Runde {{ currentViewingRound }}. Vergleichen Sie Ihre Ergebnisse mit anderen Teilnehmern und verfolgen Sie Ihre Entwicklung.
        </p>
      </div>
    </div>

    <!-- Capital History Chart -->
    @if (availableRounds.length > 0) {
    <div
      class="bg-gray-900 border border-gray-800 rounded-[2.5rem] p-6 md:p-10 h-[500px] relative group shadow-2xl overflow-hidden flex flex-col">
      <!-- Background Decoration -->
      <div class="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-emerald-500/10 blur-[100px] rounded-full">
        </div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-500/10 blur-[100px] rounded-full">
        </div>
      </div>

      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 relative z-10">
        <h3
          class="text-sm font-bold text-white uppercase tracking-[0.2em] pl-1">
          Kapitalverlauf über die Runden
        </h3>
        <!-- Legend -->
        <div class="flex flex-wrap gap-4 text-[10px] uppercase font-black">
          @for (p of players; track p.uid) {
          <div class="flex items-center gap-2">
            <div class="w-3 h-0.5 rounded-full" [ngClass]="p.isCurrentPlayer ? 'bg-emerald-500' : 'bg-blue-500'"
              [style.opacity]="p.isCurrentPlayer ? '1' : '0.4'"></div>
            <span [class.text-emerald-400]="p.isCurrentPlayer" [class.text-gray-300]="!p.isCurrentPlayer">
              {{ p.name }}
            </span>
          </div>
          }
        </div>
      </div>

      <div class="flex-grow relative">
        <!-- SVG Graph -->
        <svg [attr.viewBox]="'0 0 ' + VIEWBOX_WIDTH + ' ' + VIEWBOX_HEIGHT"
          class="w-full h-full relative z-10">
          <defs>
            <!-- Chart Line Gradients -->
            <linearGradient id="currentPlayerGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#10b981" />
              <stop offset="100%" stop-color="#34d399" />
            </linearGradient>
            <linearGradient id="otherPlayerGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#3b82f6" />
              <stop offset="100%" stop-color="#60a5fa" />
            </linearGradient>

            <!-- Area Gradients -->
            <linearGradient id="currentPlayerArea" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#10b981" stop-opacity="0.2" />
              <stop offset="100%" stop-color="#10b981" stop-opacity="0" />
            </linearGradient>

            <!-- Glow Filters -->
            <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
              <feGaussianBlur stdDeviation="1.5" result="blur" />
              <feComposite in="SourceGraphic" in2="blur" operator="over" />
            </filter>
          </defs>

          <!-- Selected Round Highlight -->
          <rect
            [attr.x]="GRAPH_MARGIN.left + ((currentViewingRound - 1) / availableRounds.length) * (VIEWBOX_WIDTH - GRAPH_MARGIN.left - GRAPH_MARGIN.right)"
            [attr.y]="GRAPH_MARGIN.top"
            [attr.width]="(1 / availableRounds.length) * (VIEWBOX_WIDTH - GRAPH_MARGIN.left - GRAPH_MARGIN.right)"
            [attr.height]="VIEWBOX_HEIGHT - GRAPH_MARGIN.top - GRAPH_MARGIN.bottom" fill="white" fill-opacity="0.05"
            class="transition-all duration-500" />

          <!-- Grid Lines (Horizontal) -->
          @for (line of [0, 25, 50, 75, 100]; track line) {
          <line [attr.x1]="GRAPH_MARGIN.left"
            [attr.y1]="GRAPH_MARGIN.top + (line / 100) * (VIEWBOX_HEIGHT - GRAPH_MARGIN.top - GRAPH_MARGIN.bottom)"
            [attr.x2]="VIEWBOX_WIDTH - GRAPH_MARGIN.right"
            [attr.y2]="GRAPH_MARGIN.top + (line / 100) * (VIEWBOX_HEIGHT - GRAPH_MARGIN.top - GRAPH_MARGIN.bottom)"
            stroke="white" stroke-width="0.5" stroke-dasharray="2,4" vector-effect="non-scaling-stroke"
            class="opacity-10" />

          <text [attr.x]="GRAPH_MARGIN.left - 20"
            [attr.y]="GRAPH_MARGIN.top + (line / 100) * (VIEWBOX_HEIGHT - GRAPH_MARGIN.top - GRAPH_MARGIN.bottom) + 4"
            class="fill-gray-400 text-[14px] font-black font-mono tracking-tighter" text-anchor="end">
            {{ ((100 - line) / 100) * getMaxCapital() | currency: 'EUR' : 'symbol' : '1.0-0' }}
          </text>
          }

          <!-- Grid Lines (Vertical - Rounds) -->
          @for (r of availableRounds; track r; let i = $index) {
          <!-- Line for Round N (Start of next round) -->
          <line
            [attr.x1]="GRAPH_MARGIN.left + (i / availableRounds.length) * (VIEWBOX_WIDTH - GRAPH_MARGIN.left - GRAPH_MARGIN.right)"
            [attr.y1]="GRAPH_MARGIN.top"
            [attr.x2]="GRAPH_MARGIN.left + (i / availableRounds.length) * (VIEWBOX_WIDTH - GRAPH_MARGIN.left - GRAPH_MARGIN.right)"
            [attr.y2]="VIEWBOX_HEIGHT - GRAPH_MARGIN.bottom" stroke="white" stroke-width="0.5" stroke-dasharray="2,4"
            vector-effect="non-scaling-stroke" class="opacity-10" />

          <text
            [attr.x]="GRAPH_MARGIN.left + (i / availableRounds.length) * (VIEWBOX_WIDTH - GRAPH_MARGIN.left - GRAPH_MARGIN.right)"
            [attr.y]="VIEWBOX_HEIGHT - GRAPH_MARGIN.bottom + 25"
            class="fill-gray-400 text-[13px] font-black font-mono tracking-widest" text-anchor="middle"
            [class.fill-emerald-400]="currentViewingRound === r">
            R{{ r }}
          </text>
          }
          <!-- Last vertical line for the current round (start of) -->
          <line [attr.x1]="VIEWBOX_WIDTH - GRAPH_MARGIN.right" [attr.y1]="GRAPH_MARGIN.top"
            [attr.x2]="VIEWBOX_WIDTH - GRAPH_MARGIN.right" [attr.y2]="VIEWBOX_HEIGHT - GRAPH_MARGIN.bottom"
            stroke="white" stroke-width="0.5" stroke-dasharray="2,4" vector-effect="non-scaling-stroke"
            class="opacity-10" />
          <text [attr.x]="VIEWBOX_WIDTH - GRAPH_MARGIN.right" [attr.y]="VIEWBOX_HEIGHT - GRAPH_MARGIN.bottom + 25"
            class="fill-emerald-400 text-[13px] font-black font-mono tracking-widest" text-anchor="middle"
            [class.fill-emerald-400]="currentViewingRound > availableRounds.length">
            R{{ game.currentRoundNumber + 1 }}
          </text>


          <!-- Data Lines -->
          @for (p of players; track p.uid) {
          @if (p.isCurrentPlayer) {
          <!-- Current Player Area Fill -->
          <path [attr.d]="getGraphAreaPath(p.capitalHistory)" fill="url(#currentPlayerArea)"
            class="transition-all duration-1000" />
          }

          <!-- Main Line -->
          <path [attr.d]="getGraphPath(p.capitalHistory)" fill="none"
            [attr.stroke]="p.isCurrentPlayer ? 'url(#currentPlayerGradient)' : 'url(#otherPlayerGradient)'"
            [attr.stroke-width]="p.isCurrentPlayer ? 4 : 2" [attr.filter]="p.isCurrentPlayer ? 'url(#glow)' : ''"
            vector-effect="non-scaling-stroke" [attr.opacity]="p.isCurrentPlayer ? 1 : 0.2" stroke-linecap="round"
            stroke-linejoin="round" class="transition-all duration-1000 ease-out" />

          <!-- Points -->
          @for (point of getGraphPoints(p.capitalHistory); track point.round) {
          <g class="transition-all duration-500 hover:scale-150 transform-gpu cursor-pointer">
            <circle [attr.cx]="point.x" [attr.cy]="point.y" [attr.r]="p.isCurrentPlayer ? 5 : 3"
              [attr.fill]="p.isCurrentPlayer ? '#10b981' : '#3b82f6'"
              [attr.stroke]="p.isCurrentPlayer ? '#064e3b' : '#1e3a8a'" stroke-width="1"
              [attr.opacity]="p.isCurrentPlayer ? 1 : 0.4">
              <title>{{ p.name }} - Round {{ point.round }}: {{ point.val | currency: 'EUR' : 'symbol' : '1.0-0' }}
              </title>
            </circle>
          </g>
          }
          }
        </svg>
      </div>
    </div>
    }

    <div
      class="rounded-3xl border border-gray-800 bg-gray-900 shadow-2xl overflow-x-auto scrollbar-thin scrollbar-track-gray-950 scrollbar-thumb-gray-700 hover:scrollbar-thumb-emerald-600/50">
      <table class="w-full min-w-max text-left border-collapse">
        <thead>
          <tr class="bg-gray-800/40">
            <th
              class="p-4 text-xs font-black text-white uppercase tracking-[0.2em] border-b border-gray-800">
              Kategorie
            </th>
            @for (p of players; track p) {
            <th class="p-4 text-sm font-bold border-b border-gray-800 text-center min-w-[100px]">
              <div class="flex flex-col items-center gap-1">
                <span [class.text-emerald-400]="p.uid === playerUid" [class.text-blue-400]="p.uid !== playerUid">{{
                  p.name
                  }}</span>
              </div>
            </th>
            }
          </tr>
        </thead>
        <tbody class="text-gray-300">
          <!-- Previous Decisions -->
          <tr class="bg-gray-800/10 cursor-pointer hover:bg-gray-800/30 transition-colors"
            (click)="toggleSection('decisions')">
            <td colspan="100%" class="px-6 py-2 border-b border-gray-800/50">
              <div class="flex items-center gap-2">
                <span class="text-[10px] transition-transform duration-300"
                  [class.rotate-90]="expandedSections['decisions']">▶</span>
                <span
                  class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">
                  Entscheidungen
                </span>
              </div>
            </td>
          </tr>
          @if (expandedSections['decisions']) {
          <tr class="hover:bg-gray-800/20 transition-colors">
            <td
              class="p-3 pl-8 text-sm text-gray-200 border-b border-gray-800/50">
              Mineraldünger
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-mono text-xs">
              @if (p.decision?.fertilizer) {
              <span class="text-emerald-500 text-base">●</span>
              } @else {
              <span class="text-gray-800 text-base">○</span>
              }
            </td>
            }
          </tr>
          <tr class="hover:bg-gray-800/20 transition-colors">
            <td
              class="p-3 pl-8 text-sm text-gray-200 border-b border-gray-800/50">
              Pflanzenschutz
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-mono text-xs">
              @if (p.decision?.pesticide) {
              <span class="text-red-500 text-base">●</span>
              } @else {
              <span class="text-gray-800 text-base">○</span>
              }
            </td>
            }
          </tr>
          <tr class="hover:bg-gray-800/20 transition-colors">
            <td
              class="p-3 pl-8 text-sm text-gray-200 border-b border-gray-800/50">
              Nützlinge
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-mono text-xs">
              @if (p.decision?.organisms) {
              <span class="text-emerald-500 text-base">●</span>
              } @else {
              <span class="text-gray-800 text-base">○</span>
              }
            </td>
            }
          </tr>
          <tr class="hover:bg-gray-800/20 transition-colors">
            <td
              class="p-3 pl-8 text-sm text-gray-200 border-b border-gray-800/50">
              Ökologischer Landbau
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-mono text-xs">
              @if (p.decision?.organic) {
              <span class="text-emerald-500 text-base">●</span>
              } @else {
              <span class="text-gray-800 text-base">○</span>
              }
            </td>
            }
          </tr>
          }


          <!-- Expenses Detail -->
          <tr class="bg-gray-800/10 border-b border-gray-800/50">
            <td colspan="100%">
              <div class="px-6 py-2 flex items-center justify-between">
                <span
                  class="text-[10px] font-bold text-gray-300 uppercase tracking-widest">Ausgaben</span>
              </div>
            </td>
          </tr>

          <!-- Seeds Breakdown -->
          <tr class="group hover:bg-gray-800/20 transition-colors cursor-pointer" (click)="toggleSection('seeds')">
            <td class="p-3 pl-8 text-sm font-bold text-gray-200 border-b border-gray-800/50">
              <div class="flex items-center gap-2">
                <span class="text-[10px] transition-transform duration-300"
                  [class.rotate-90]="expandedSections['seeds']">▶</span>
                <span>Saatgut</span>
              </div>
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-bold text-red-400/80">
              @if (!expandedSections['seeds']) {
              {{ p.result?.expenses?.seeds | currency: 'EUR' : 'symbol' : '1.0-0' }}
              }
            </td>
            }
          </tr>
          @if (expandedSections['seeds']) {
          <tr class="bg-black/20 border-b border-gray-800/30">
            <td class="p-3 pl-12 text-sm font-bold text-gray-400">Gesamt</td>
            @for (p of players; track p) {
            <td class="p-3 text-center font-bold text-red-400">
              {{ p.result?.expenses?.seeds | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          @for (crop of ['Wheat', 'Corn', 'Potato', 'Beet', 'Barley', 'Oat', 'Rye', 'Fieldbean']; track crop) {
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">{{ t('crop.' + crop.toLowerCase()) }}
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.seeds?.[crop] || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          }
          }

          <!-- Labor Costs Breakdown -->
          <tr class="group hover:bg-gray-800/20 transition-colors cursor-pointer" (click)="toggleSection('labor')">
            <td class="p-3 pl-8 text-sm font-bold text-gray-200 border-b border-gray-800/50">
              <div class="flex items-center gap-2">
                <span class="text-[10px] transition-transform duration-300"
                  [class.rotate-90]="expandedSections['labor']">▶</span>
                <span>Personalkosten</span>
              </div>
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-bold text-red-400/80">
              @if (!expandedSections['labor']) {
              {{ p.result?.expenses?.labor | currency: 'EUR' : 'symbol' : '1.0-0' }}
              }
            </td>
            }
          </tr>
          @if (expandedSections['labor']) {
          <tr class="bg-black/20 border-b border-gray-800/30">
            <td class="p-3 pl-12 text-sm font-bold text-gray-400">Gesamt</td>
            @for (p of players; track p) {
            <td class="p-3 text-center font-bold text-red-400">
              {{ p.result?.expenses?.labor | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">Lohnkosten (Grundbetrag)</td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ GAME_CONSTANTS.MACHINE_FACTORS.BASE_LABOR_COST * (game.settings.length || 20) / 20 | currency: 'EUR'
              : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">Einsparung durch Maschinen</td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              -{{ (GAME_CONSTANTS.MACHINE_FACTORS.BASE_LABOR_COST * (game.settings.length || 20) / 20) -
              (p.result?.expenses?.labor || 0) | currency: 'EUR' :
              'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          }

          <!-- Investments Breakdown -->
          <tr class="group hover:bg-gray-800/20 transition-colors cursor-pointer"
            (click)="toggleSection('investments')">
            <td class="p-3 pl-8 text-sm font-bold text-gray-200 border-b border-gray-800/50">
              <div class="flex items-center gap-2">
                <span class="text-[10px] transition-transform duration-300"
                  [class.rotate-90]="expandedSections['investments']">▶</span>
                <span>Investitionen</span>
              </div>
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-bold text-red-400/80">
              @if (!expandedSections['investments']) {
              {{ p.result?.expenses?.investments | currency: 'EUR' : 'symbol' : '1.0-0' }}
              }
            </td>
            }
          </tr>
          @if (expandedSections['investments']) {
          <tr class="bg-black/20 border-b border-gray-800/30">
            <td class="p-3 pl-12 text-sm font-bold text-gray-400">Gesamt</td>
            @for (p of players; track p) {
            <td class="p-3 text-center font-bold text-red-400">
              {{ p.result?.expenses?.investments | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">Maschinen</td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.investments?.machines || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">
              Tierbestand
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.investments?.animals || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          }

          <!-- Running Costs Breakdown -->
          <tr class="group hover:bg-gray-800/20 transition-colors cursor-pointer" (click)="toggleSection('running')">
            <td class="p-3 pl-8 text-sm font-bold text-gray-200 border-b border-gray-800/50">
              <div class="flex items-center gap-2">
                <span class="text-[10px] transition-transform duration-300"
                  [class.rotate-90]="expandedSections['running']">▶</span>
                <span>Betriebskosten</span>
              </div>
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-bold text-red-400/80">
              @if (!expandedSections['running']) {
              {{ p.result?.expenses?.running | currency: 'EUR' : 'symbol' : '1.0-0' }}
              }
            </td>
            }
          </tr>
          @if (expandedSections['running']) {
          <tr class="bg-black/20 border-b border-gray-800/30">
            <td class="p-3 pl-12 text-sm font-bold text-gray-400">Gesamt</td>
            @for (p of players; track p) {
            <td class="p-3 text-center font-bold text-red-400">
              {{ p.result?.expenses?.running | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">Grundkosten</td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.running?.base || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">
              Bio-Kontrolle
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.running?.organic_control || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">
              Pflanzenschutzmittel
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.running?.pesticide || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">
              Nützlinge (Kosten)
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.running?.organisms || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">
              Tierhaltung
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedExpenses?.running?.animals || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          }


          <!-- Income Breakdown -->
          <tr class="group hover:bg-gray-800/20 transition-colors cursor-pointer" (click)="toggleSection('harvest')">
            <td class="p-3 pl-8 text-sm font-bold text-emerald-400 border-b border-gray-800/50">
              <div class="flex items-center gap-2">
                <span class="text-[10px] transition-transform duration-300"
                  [class.rotate-90]="expandedSections['harvest']">▶</span>
                <span>Einnahmen</span>
              </div>
            </td>
            @for (p of players; track p) {
            <td class="p-3 border-b border-gray-800/50 text-center font-black text-emerald-500/80">
              @if (!expandedSections['harvest']) {
              +{{ p.detailedIncome?.total | currency: 'EUR' : 'symbol' : '1.0-0' }}
              }
            </td>
            }
          </tr>
          @if (expandedSections['harvest']) {
          <tr class="bg-black/20 border-b border-gray-800/30">
            <td class="p-3 pl-12 text-sm font-bold text-emerald-400">Gesamt</td>
            @for (p of players; track p) {
            <td class="p-3 text-center font-black text-emerald-500">
              +{{ p.detailedIncome?.total | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td
              class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">
              Subventionen
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              {{ p.detailedIncome?.subsidies || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-black/5 text-[10px] uppercase font-bold text-gray-500">
            <td class="p-1 pl-12 border-b border-gray-800/20">Ernteverkauf</td>
            @for (p of players; track p) {
            <td class="p-1 border-b border-gray-800/20 text-center"></td>
            }
          </tr>
          @for (crop of ['Wheat', 'Corn', 'Potato', 'Beet', 'Barley', 'Oat', 'Rye', 'Fieldbean']; track crop) {
          <tr class="bg-black/10 text-xs hover:bg-black/20 transition-colors">
            <td class="p-2 pl-12 border-b border-gray-800/30 italic text-gray-300">
              {{ t('crop.' + crop.toLowerCase()) }}
            </td>
            @for (p of players; track p) {
            <td class="p-2 border-b border-gray-800/30 text-center font-mono text-xs text-gray-200">
              <div class="flex flex-col items-center">
                <span>{{ p.detailedIncome?.harvest?.[crop] || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}</span>
                @if (p.result?.marketPrices?.[crop]) {
                  <span class="text-[9px] text-emerald-500/40 font-bold">
                    @ {{ p.result?.marketPrices?.[crop] | currency: 'EUR' : 'symbol' : '1.0-2' }}
                  </span>
                }
              </div>
            </td>
            }
          </tr>
          }
          }


          <!-- Global Totals -->
          <tr class="bg-gray-900 border-t-2 border-gray-700">
            <td
              class="p-4 text-sm font-bold text-white uppercase tracking-wider">Rundenergebnis</td>
            @for (p of players; track p) {
            <td class="p-4 text-center text-base font-black font-mono"
              [class.text-emerald-500]="(p.result?.profit || 0) >= 0"
              [class.text-red-500]="(p.result?.profit || 0) < 0">
              @if ((p.result?.profit || 0) > 0) {
              <span>+</span>
              }
              {{ p.result?.profit | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
          <tr class="bg-gray-900 border-t border-gray-800">
            <td
              class="p-4 text-xs font-bold text-gray-300 uppercase tracking-wider italic">Umsatzrendite</td>
            @for (p of players; track p) {
            <td class="p-4 text-center text-xs font-bold font-mono text-gray-200">
              @if ((p.profitMargin || 0) > 0) {
              <span>+</span>
              }
              {{ p.profitMargin | number: '1.1-1' }}%
            </td>
            }
          </tr>
          <tr class="bg-gray-950">
            <td
              class="p-4 text-sm font-bold text-white uppercase tracking-wider">Gesamtkapital</td>
            @for (p of players; track p) {
            <td class="p-4 text-center text-lg font-black text-yellow-400 font-mono">
              {{ p.result?.capital || p.prevResult?.capital || 0 | currency: 'EUR' : 'symbol' : '1.0-0' }}
            </td>
            }
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>