<div class="h-screen w-screen text-white select-none relative font-sans overflow-hidden flex flex-col">

    <!-- Dark overlay for readability -->
    <div *ngIf="user$ | async" class="absolute inset-0 bg-black/30 z-0 pointer-events-none"></div>

    <!-- Login Overlay -->
    <div *ngIf="!(user$ | async)"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-black/40 backdrop-blur-lg p-4">
        <div class="flex flex-col md:flex-row gap-8 w-full max-w-4xl">

            <!-- Admin Login -->
            <div
                class="flex-1 bg-gray-900 border border-emerald-900/50 p-8 rounded-2xl shadow-2xl text-center flex flex-col items-center justify-center relative overflow-hidden group">
                <div class="absolute inset-0 bg-emerald-900/10 group-hover:bg-emerald-900/20 transition duration-500">
                </div>
                <h2 class="text-3xl font-bold text-emerald-400 mb-4 font-serif relative z-10"
                    i18n="@@board.login.adminTitle">Admin Access</h2>
                <p class="text-gray-400 mb-8 relative z-10" i18n="@@board.login.adminDesc">Manage games and orchestrate
                    the simulation.</p>
                <button (click)="login()"
                    class="relative z-10 px-8 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-full transition transform hover:scale-105 shadow-lg flex items-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27c3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10c5.35 0 9.25-3.67 9.25-9.09c0-1.15-.15-1.81-.15-1.81Z" />
                    </svg>
                    <span i18n="@@board.login.btnGoogle">Login with Google</span>
                </button>
            </div>

            <!-- Player Login -->
            <div
                class="flex-1 bg-gray-900 border border-blue-900/50 p-8 rounded-2xl shadow-2xl flex flex-col items-center justify-center relative overflow-hidden group">
                <div class="absolute inset-0 bg-blue-900/10 group-hover:bg-blue-900/20 transition duration-500"></div>
                <h2 class="text-3xl font-bold text-blue-400 mb-4 font-serif relative z-10"
                    i18n="@@board.login.playerTitle">Player Access</h2>
                <p class="text-gray-400 mb-6 relative z-10" i18n="@@board.login.playerDesc">Enter Game ID and
                    credentials.</p>

                <div class="w-full max-w-xs relative z-10 flex flex-col gap-4">
                    <input [(ngModel)]="gameId" type="text" placeholder="Game ID"
                        i18n-placeholder="@@board.login.phGameId"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 transition">
                    <input [(ngModel)]="playerNumber" type="text" placeholder="Player # (e.g. 1)"
                        i18n-placeholder="@@board.login.phPlayerNum"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 transition">
                    <input [(ngModel)]="pin" type="password" placeholder="Game Password"
                        i18n-placeholder="@@board.login.phPin"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-blue-500 transition">

                    <button (click)="playerLogin()"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition transform hover:scale-105 shadow-lg">
                        <ng-container i18n="@@board.login.btnLogin">Login</ng-container>
                    </button>

                    <p *ngIf="authError" class="text-red-400 text-sm mt-2 text-center">{{ authError }}</p>
                </div>
            </div>

        </div>
    </div>

    <div *ngIf="user$ | async as user" class="relative z-10 h-full flex flex-col">
        <div
            class="bg-gray-900/95 border-b border-gray-700 backdrop-blur shadow-lg px-6 py-3 flex items-center justify-between shrink-0 h-16">
            <button (click)="toggleMobileMenu()" class="lg:hidden p-2 hover:bg-gray-800 rounded-lg text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <!-- Left Side: Logo & Stats -->
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold font-serif text-emerald-500 tracking-wider hidden sm:block">SOIL</h1>
                <div class="h-6 w-px bg-gray-700 hidden sm:block"></div>
                <div *ngIf="gameState$ | async as state"
                    class="flex gap-4 text-gray-200 font-mono text-sm md:text-base">
                    <span class="text-yellow-400">{{state.capital | currency:'EUR':'symbol':'1.0-0'}}</span>
                </div>
            </div>

            <!-- Center/Right: Desktop Controls -->
            <div class="hidden lg:flex items-center gap-3">
                <!-- User Info -->
                <div class="flex items-center gap-2 mr-2 px-3 py-1 bg-gray-800/50 rounded-full border border-gray-700">
                    <img *ngIf="!isPlayer" [src]="user.photoURL" class="w-6 h-6 rounded-full border border-gray-600">
                    <ng-container *ngIf="!isEditingName; else editModeDesktop">
                        <span
                            class="text-xs font-medium text-gray-300 cursor-pointer hover:text-emerald-400 px-2 py-1 -mx-2 -my-1"
                            (click)="startEditName(); $event.stopPropagation()">
                            {{ (isPlayer && !user.displayName) ? (playerLabel + ' ' + (playerNumber || '')) :
                            user.displayName }}
                        </span>
                    </ng-container>
                    <ng-template #editModeDesktop>
                        <input [(ngModel)]="tempName" (keyup.enter)="saveName()" (blur)="saveName()"
                            class="bg-gray-800 text-xs text-white border-b border-emerald-500 focus:outline-none w-24 px-1"
                            autoFocus (click)="$event.stopPropagation()">
                    </ng-template>
                </div>

                <!-- Toggle Buttons -->
                <button (click)="toggleLabels()" class="px-3 py-1 font-bold text-[10px] rounded-lg border transition"
                    [class.bg-emerald-600]="showLabels" [class.text-white]="showLabels"
                    [class.border-emerald-500]="showLabels" [class.bg-gray-800]="!showLabels"
                    [class.text-gray-400]="!showLabels" [class.border-gray-700]="!showLabels" i18n="@@board.nav.names">
                    NAMES
                </button>
                <button (click)="toggleNutrition()" class="px-3 py-1 font-bold text-[10px] rounded-lg border transition"
                    [class.bg-blue-600]="showNutritionOverlay" [class.text-white]="showNutritionOverlay"
                    [class.border-blue-500]="showNutritionOverlay" [class.bg-gray-800]="!showNutritionOverlay"
                    [class.text-gray-400]="!showNutritionOverlay" [class.border-gray-700]="!showNutritionOverlay"
                    i18n="@@board.nav.nutrition">
                    NUTRITION
                </button>
                <button (click)="toggleHarvest()" class="px-3 py-1 font-bold text-[10px] rounded-lg border transition"
                    [class.bg-yellow-600]="showHarvestOverlay" [class.text-white]="showHarvestOverlay"
                    [class.border-yellow-500]="showHarvestOverlay" [class.bg-gray-800]="!showHarvestOverlay"
                    [class.text-gray-400]="!showHarvestOverlay" [class.border-gray-700]="!showHarvestOverlay"
                    i18n="@@board.nav.harvest">
                    HARVEST
                </button>
                <button (click)="toggleSoil()" class="px-3 py-1 font-bold text-[10px] rounded-lg border transition"
                    [class.bg-emerald-700]="showSoilOverlay" [class.text-white]="showSoilOverlay"
                    [class.border-emerald-600]="showSoilOverlay" [class.bg-gray-800]="!showSoilOverlay"
                    [class.text-gray-400]="!showSoilOverlay" [class.border-gray-700]="!showSoilOverlay"
                    i18n="@@board.nav.soil">
                    SOIL
                </button>

                <div class="h-6 w-px bg-gray-700 mx-1"></div>

                <!-- Action Buttons -->
                <button (click)="openRoundSettings()" [disabled]="isReadOnly"
                    class="px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold rounded-lg border border-gray-600 transition text-[10px] flex items-center gap-1 disabled:opacity-50"
                    i18n="@@board.nav.options">
                    OPTIONS
                </button>
                <button (click)="nextRound()" [disabled]="isReadOnly || isSubmitted || viewingRound < maxRoundNumber"
                    class="px-3 py-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg border border-emerald-500 transition text-[10px] disabled:bg-gray-700 disabled:border-gray-600 disabled:text-gray-500">
                    <ng-container *ngIf="isSubmitted" i18n="@@board.nav.waiting">WAITING...</ng-container>
                    <ng-container *ngIf="!isSubmitted" i18n="@@board.nav.nextRound">NEXT ROUND</ng-container>
                </button>
            </div>

            <!-- Right Side: Utility -->
            <div class="flex items-center gap-3">
                <app-language-switcher></app-language-switcher>
                <button (click)="logout()"
                    class="p-2 hover:bg-red-900/30 rounded-lg text-red-400 hover:text-red-300 transition" title="Logout"
                    i18n-title="@@board.logout">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Side Menu Overlay -->
        <div *ngIf="showMobileMenu" class="fixed inset-0 z-[100] lg:hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="toggleMobileMenu()"></div>
            <!-- Menu Content -->
            <div
                class="absolute top-0 left-0 bottom-0 w-64 bg-gray-900 shadow-2xl flex flex-col border-r border-gray-700 animate-slide-in-left">
                <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                    <h2 class="text-xl font-bold font-serif text-emerald-500">MENU</h2>
                    <button (click)="toggleMobileMenu()" class="text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-4 space-y-6">
                    <!-- Navigation -->
                    <nav class="p-4 space-y-1">
                        <div class="px-2 py-3 flex justify-center">
                            <!-- Removed app-language-switcher to satisfy minimal requirement -->
                        </div>
                        <div class="h-px bg-gray-800 mx-2 my-2"></div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest"
                            i18n="@@board.mobile.overlays">Visual Overlays</label>
                        <div class="grid grid-cols-1 gap-2">
                            <button (click)="toggleLabels(); toggleMobileMenu()"
                                class="w-full text-left px-4 py-3 rounded-xl border transition"
                                [class.bg-emerald-600]="showLabels" [class.border-emerald-500]="showLabels"
                                [class.bg-gray-800]="!showLabels" [class.border-gray-700]="!showLabels">
                                <ng-container i18n="@@board.mobile.names">Names Overlay</ng-container>
                            </button>
                            <button (click)="toggleNutrition(); toggleMobileMenu()"
                                class="w-full text-left px-4 py-3 rounded-xl border transition"
                                [class.bg-blue-600]="showNutritionOverlay"
                                [class.border-blue-500]="showNutritionOverlay"
                                [class.bg-gray-800]="!showNutritionOverlay"
                                [class.text-gray-400]="!showNutritionOverlay"
                                [class.border-gray-700]="!showNutritionOverlay">
                                <ng-container i18n="@@board.mobile.nutrition">Nutrition Overlay</ng-container>
                            </button>
                            <button (click)="toggleHarvest(); toggleMobileMenu()"
                                class="w-full text-left px-4 py-3 rounded-xl border transition"
                                [class.bg-yellow-600]="showHarvestOverlay"
                                [class.border-yellow-500]="showHarvestOverlay" [class.bg-gray-800]="!showHarvestOverlay"
                                [class.text-gray-400]="!showHarvestOverlay"
                                [class.border-gray-700]="!showHarvestOverlay">
                                <ng-container i18n="@@board.mobile.harvest">Harvest Overlay</ng-container>
                            </button>
                            <button (click)="toggleSoil(); toggleMobileMenu()"
                                class="w-full text-left px-4 py-3 rounded-xl border transition"
                                [class.bg-emerald-700]="showSoilOverlay" [class.border-emerald-600]="showSoilOverlay"
                                [class.bg-gray-800]="!showSoilOverlay" [class.text-gray-400]="!showSoilOverlay"
                                [class.border-gray-700]="!showSoilOverlay">
                                <ng-container i18n="@@board.mobile.soil">Soil Quality Overlay</ng-container>
                            </button>
                        </div>
                    </nav>

                    <!-- Game Actions Section -->
                    <div class="space-y-3">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest"
                            i18n="@@board.mobile.actions">Game Actions</label>
                        <button (click)="openRoundSettings(); toggleMobileMenu()" [disabled]="isReadOnly"
                            class="w-full py-4 bg-gray-800 hover:bg-gray-700 text-white font-bold rounded-xl border border-gray-700 transition flex items-center justify-center gap-2">
                            <ng-container i18n="@@board.mobile.roundOptions">ROUND OPTIONS</ng-container>
                        </button>
                        <button (click)="nextRound(); toggleMobileMenu()"
                            [disabled]="isReadOnly || isSubmitted || viewingRound < maxRoundNumber"
                            class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl border border-emerald-500 transition shadow-lg flex items-center justify-center">
                            <ng-container *ngIf="isSubmitted" i18n="@@board.mobile.waiting">WAITING FOR
                                OTHERS...</ng-container>
                            <ng-container *ngIf="!isSubmitted" i18n="@@board.mobile.nextRound">NEXT ROUND</ng-container>
                        </button>
                    </div>
                </div>

                <div class="p-4 bg-gray-950 border-t border-gray-800">
                    <div *ngIf="user$ | async as user" class="flex items-center gap-3">
                        <img *ngIf="!isPlayer" [src]="user.photoURL"
                            class="w-8 h-8 rounded-full border border-gray-700">
                        <div class="flex flex-col">
                            <ng-container *ngIf="!isEditingName; else editModeMobile">
                                <span
                                    class="text-xs font-bold text-white cursor-pointer hover:text-emerald-400 p-2 -m-2"
                                    (click)="startEditName(); $event.stopPropagation()">
                                    {{ (isPlayer && !user.displayName) ? (playerLabel + ' ' + (playerNumber || '')) :
                                    user.displayName }}
                                </span>
                            </ng-container>
                            <ng-template #editModeMobile>
                                <input [(ngModel)]="tempName" (keyup.enter)="saveName()" (blur)="saveName()"
                                    class="bg-gray-900 text-xs text-white border-b border-emerald-500 focus:outline-none w-24 px-1"
                                    autoFocus>
                            </ng-template>
                            <span class="text-[10px] text-gray-500" i18n="@@board.activePlayer">Active Player</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Board Area -->
        <div class="relative flex-1 w-full min-h-0 flex flex-col items-center justify-center overflow-hidden board-container"
            (click)="onBackgroundClick($event)">

            <!-- Read Only Banner -->
            <div *ngIf="showReadOnlyBanner" class="absolute top-4 left-1/2 -translate-x-1/2 z-50 pointer-events-none">
                <div
                    class="bg-amber-500/90 text-black px-6 py-2 rounded-full font-bold shadow-lg border-2 border-amber-300 backdrop-blur-sm animate-pulse">
                    <ng-container i18n="@@board.banner.readOnly">READ ONLY MODE</ng-container>
                </div>
            </div>

            <!-- Error Modal -->
            <div *ngIf="errorMessage"
                class="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"
                (click)="errorMessage = ''">
                <div class="bg-red-900/90 border border-red-500 p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center"
                    (click)="$event.stopPropagation()">
                    <div class="text-red-200 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2" i18n="@@board.error.title">Error</h3>
                    <p class="text-red-100 mb-6">{{ errorMessage }}</p>
                    <button (click)="errorMessage = ''"
                        class="px-6 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition-colors"
                        i18n="@@board.error.close">
                        Close
                    </button>
                </div>
            </div>

            <app-round-settings-modal *ngIf="showRoundSettingsModal" [settings]="currentRoundSettings"
                (save)="onRoundSettingsSaved($event)" (cancel)="showRoundSettingsModal = false">
            </app-round-settings-modal>

            <app-planting-modal *ngIf="showPlantingModal" [crops]="availableCrops" (selected)="onCropSelected($event)"
                (cancel)="onPlantingCancel()">
            </app-planting-modal>

            <!-- Round Header (Static Flex Item) -->
            <div class="shrink-0 pt-6 pb-1 flex flex-col items-center gap-1 z-30">
                <!-- Round Selector (History) -->
                <div *ngIf="history.length > 0"
                    class="flex items-center gap-1 bg-gray-900/60 backdrop-blur rounded-full px-4 py-1 border border-gray-700 pointer-events-auto">
                    <button (click)="goToRound(viewingRound - 1)" [disabled]="viewingRound === 0"
                        class="text-gray-400 hover:text-white disabled:opacity-30 disabled:pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                    <span class="text-xs font-mono px-2 min-w-[100px] text-center transition-colors"
                        [class.text-emerald-400]="viewingRound === maxRoundNumber"
                        [class.text-gray-400]="viewingRound < maxRoundNumber">
                        <ng-container i18n="@@board.round">Round</ng-container> {{viewingRound}}
                    </span>
                    <button (click)="goToRound(viewingRound + 1)" [disabled]="viewingRound >= maxRoundNumber"
                        class="text-gray-400 hover:text-white disabled:opacity-30 disabled:pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Grid (Flex Grow) -->
            <div class="flex-1 w-full min-h-0 p-2 lg:p-4 flex items-center justify-center overflow-hidden">
                <div class="game-grid grid gap-2 max-w-7xl touch-none" [style.--cols]="cols" [style.--rows]="rows"
                    (touchstart)="onTouchStart($event)" (touchmove)="onTouchMove($event)"
                    (touchend)="onTouchEnd($event)" (click)="$event.stopPropagation()">
                    <app-parcel *ngFor="let parcel of parcels; let i = index" [parcel]="parcel" [attr.data-index]="i"
                        class="aspect-square" [selected]="isSelected(parcel.index)" [showLabels]="showLabels"
                        [showNutrition]="showNutritionOverlay" [showHarvest]="showHarvestOverlay"
                        [showSoil]="showSoilOverlay" (mousedown)="onMouseDown(parcel.index, $event)"
                        (mouseenter)="onMouseEnter(parcel.index)">
                    </app-parcel>
                </div>
            </div>
        </div>
    </div>
</div>