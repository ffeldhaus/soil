<div class="ml-12">
  <div class="flex justify-between items-center mb-4">
    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wide">
      {{ t('dashboard.details.players') }}
    </h4>
    <button
      (click)="printAllQrCodes.emit(game)"
      class="px-4 py-1.5 bg-gray-800 hover:bg-gray-700 text-white text-xs font-bold rounded border border-gray-600 transition flex items-center gap-2"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
        />
      </svg>
      {{ t('dashboard.player.printAll') }}
    </button>
  </div>

  <!-- Deadline Manager Toggle -->
  <div class="mb-4">
    <button
      (click)="showDeadlineManager = !showDeadlineManager"
      class="text-xs font-bold text-blue-400 hover:text-blue-300 uppercase tracking-widest flex items-center gap-2 transition-colors"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-4 w-4 transition-transform duration-200"
        [class.rotate-90]="showDeadlineManager"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      {{ t('dashboard.deadline.toggle') }}
    </button>
  </div>

  <!-- Deadline Manager (Collapsible) -->
  @if (showDeadlineManager) {
    <div class="mb-6 p-4 bg-gray-900/60 rounded-xl border border-blue-500/20 portrait:rounded-none portrait:border-x-0 animate-fade-in">
      <h5 class="text-xs font-bold text-blue-400 mb-3 uppercase tracking-widest">
        {{ t('dashboard.deadline.title') }}
      </h5>
      <div class="flex flex-wrap items-end gap-4">
        <div>
          <label class="block text-[10px] text-gray-500 mb-1">Runde</label>
          <div class="relative h-[30px]">
            <select
              [(ngModel)]="selectedDeadlineRound"
              class="w-full h-full bg-gray-800/50 border border-gray-700 rounded px-2 py-1 text-sm text-white focus:border-blue-500 outline-none appearance-none cursor-pointer pr-8 transition-colors"
            >
              @for (r of getRounds(); track r) {
                <option [value]="r" class="bg-gray-900 text-white">Runde {{ r }}</option>
              }
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-400">
              <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>
        </div>
        <div>
          <label for="deadline-{{ game.id }}" class="block text-[10px] text-gray-500 mb-1">
            {{ t('dashboard.deadline.round') }} {{ selectedDeadlineRound }}
          </label>
          <input
            #deadlineInput
            id="deadline-{{ game.id }}"
            type="datetime-local"
            [value]="getDeadlineForRound(game, selectedDeadlineRound)"
            class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm text-white focus:border-blue-500 outline-none"
          />
        </div>
        <button
          (click)="updateDeadline.emit({ gameId: game.id, round: selectedDeadlineRound, dateStr: deadlineInput.value })"
          class="px-4 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded transition shadow-lg"
        >
          {{ t('dashboard.deadline.set') }}
        </button>
      </div>
      <p class="text-[10px] text-gray-500 mt-2 italic">{{ t('dashboard.deadline.hint') }}</p>
    </div>
  }

  @if (!game.players || getPlayerKeys(game.players).length === 0) {
    <div class="text-gray-500 italic text-sm">
      {{ t('dashboard.details.noPlayers') }}
    </div>
  }

  <div
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 portrait:gap-0 portrait:divide-y portrait:divide-gray-800"
  >
    @for (slot of getSlots(game); track slot.number) {
      <div
        class="p-4 bg-gray-900 rounded-xl border flex flex-col gap-3 transition portrait:rounded-none portrait:border-x-0"
        [class.border-emerald-500/30]="slot.isJoined && !slot.isAi"
        [class.bg-emerald-900/10]="slot.isJoined && !slot.isAi"
        [class.border-blue-500/30]="slot.isAi"
        [class.bg-blue-900/10]="slot.isAi"
        [class.border-gray-700]="!slot.isJoined"
      >
        <!-- Header -->
        <div class="flex justify-between items-start">
          <div>
            <div class="font-bold text-white flex items-center gap-2">
              <span class="text-gray-400">#{{ slot.number }}</span>
              @if (slot.isAi) {
                <span class="text-blue-400">{{ slot.player?.displayName || t('dashboard.player.label') + ' ' + slot.number }}</span>
              }
              @if (!slot.isAi && slot.isJoined) {
                <span class="text-emerald-400">{{ slot.player?.displayName }}</span>
              }
              @if (!slot.isAi && !slot.isJoined) {
                <span class="text-gray-500">{{ t('dashboard.player.label') }} {{ slot.number }}</span>
              }
            </div>
          </div>
          @if (slot.isJoined) {
            <span
              class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider"
              [class.bg-blue-900]="slot.isAi"
              [class.text-blue-300]="slot.isAi"
              [class.bg-emerald-900]="!slot.isAi"
              [class.text-emerald-300]="!slot.isAi"
            >
              {{ slot.isAi ? 'KI TEAM' : 'AKTIV' }}
            </span>
          }
          @if (!slot.isJoined) {
            <span class="px-2 py-0.5 rounded text-[10px] bg-gray-800 text-gray-400 font-bold uppercase tracking-wider">
              EMPTY
            </span>
          }
        </div>
        <!-- Stats -->
        <div
          class="grid grid-cols-2 gap-4 text-xs bg-black/20 p-3 rounded-xl border border-white/5 portrait:rounded-none"
        >
          <div>
            <span class="block text-gray-400 text-[10px] uppercase font-bold mb-1">{{
              t('dashboard.player.capital')
            }}</span>
            <span class="font-mono text-yellow-500 font-bold text-sm">{{
              slot.player?.capital ?? 1000 | currency: 'EUR' : 'symbol' : '1.0-0'
            }}</span>
          </div>
          <div>
            <span class="block text-gray-400 text-[10px] uppercase font-bold mb-1">{{
              t('dashboard.player.round')
            }}</span>
            <span class="font-mono text-white text-sm">{{ slot.player?.currentRound ?? 0 }}</span>
          </div>
          <div>
            <span class="block text-gray-400 text-[10px] uppercase font-bold mb-1">{{
              t('dashboard.player.soil')
            }}</span>
            <div
              class="text-xs font-mono"
              [class.text-emerald-400]="(slot.player?.avgSoil || 0) > 80"
              [class.text-amber-400]="(slot.player?.avgSoil || 0) <= 80 && (slot.player?.avgSoil || 0) > 60"
              [class.text-red-400]="(slot.player?.avgSoil || 0) <= 60"
            >
              {{ slot.isJoined ? (slot.player?.avgSoil || 0 | number: '1.0-1') : '-' }}
            </div>
          </div>
          <div>
            <span class="block text-gray-400 text-[10px] uppercase font-bold mb-1">{{
              t('dashboard.player.nutrition')
            }}</span>
            <div
              class="text-xs font-mono"
              [class.text-blue-400]="(slot.player?.avgNutrition || 0) > 80"
              [class.text-amber-400]="(slot.player?.avgNutrition || 0) <= 80 && (slot.player?.avgNutrition || 0) > 60"
              [class.text-red-400]="(slot.player?.avgNutrition || 0) <= 60"
            >
              {{ slot.isJoined ? (slot.player?.avgNutrition || 0 | number: '1.0-1') : '-' }}
            </div>
          </div>
          <div class="col-span-2 pt-1 border-t border-white/5">
            <div class="flex justify-between items-center">
              <span class="text-gray-400 text-[10px] uppercase font-bold">{{ t('dashboard.player.submitted') }}</span>
              <span
                class="font-bold text-[10px] px-2 py-0.5 rounded-full"
                [class.bg-emerald-500/20]="slot.player?.submittedRound === game.currentRoundNumber"
                [class.text-emerald-400]="slot.player?.submittedRound === game.currentRoundNumber"
                [class.bg-gray-700]="slot.player?.submittedRound !== game.currentRoundNumber"
                [class.text-gray-500]="slot.player?.submittedRound !== game.currentRoundNumber"
              >
                {{ slot.player?.submittedRound === game.currentRoundNumber ? 'JA' : 'NEIN' }}
              </span>
            </div>
          </div>
        </div>
        <!-- Actions -->
        <div class="flex flex-wrap gap-2 mt-auto pt-2 border-t border-gray-700/50">
          <!-- Convert -->
          <button
            (click)="convertPlayer.emit({ game: game, slot: slot })"
            class="w-full px-2 py-1.5 rounded text-[10px] font-bold uppercase transition flex items-center justify-center gap-1 border border-transparent"
            [class.bg-emerald-800/30]="slot.isAi"
            [class.text-emerald-300]="slot.isAi"
            [class.hover:bg-emerald-800/50]="slot.isAi"
            [class.bg-blue-800/30]="!slot.isAi"
            [class.text-blue-300]="!slot.isAi"
            [class.hover:bg-blue-800/50]="!slot.isAi"
          >
            @if (slot.isAi) {
              <ng-container>{{ t('dashboard.player.toHuman') }}</ng-container>
            }
            @if (!slot.isAi) {
              <ng-container>{{ t('dashboard.player.toAi') }}</ng-container>
            }
          </button>

          <!-- Login, QR, Email (Only for humans) -->
          @if (!slot.isAi) {
            <div class="grid grid-cols-3 gap-2 w-full">
              <button
                (click)="loginAsPlayer.emit({ gameId: game.id, password: slot.password })"
                class="bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg text-[10px] font-black transition flex flex-col items-center justify-center gap-1 shadow-lg"
                title="Login as Player"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
                {{ t('dashboard.player.login') }}
              </button>

              <button
                (click)="generateQrCode.emit({ gameId: game.id, playerNumber: slot.number, password: slot.password })"
                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-[10px] font-black transition flex flex-col items-center justify-center gap-1 shadow-lg border border-gray-600"
                title="Show QR Code"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
                  />
                </svg>
                {{ t('dashboard.player.qrCode') }}
              </button>

              <button
                (click)="sharePlayer.emit({ game: game, slot: slot })"
                class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-[10px] font-black transition flex flex-col items-center justify-center gap-1 shadow-lg border border-gray-600"
                title="Send Email"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  />
                </svg>
                {{ t('dashboard.player.email') }}
              </button>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>
