<div class="bg-gray-900 text-white font-sans no-print">
  <app-dashboard-hud [user]="user$ | async" (logout)="logout()"></app-dashboard-hud>
</div>

<!-- Main Content -->
<div class="pt-24 px-4 max-w-4xl mx-auto flex flex-col gap-6 portrait:px-0 portrait:max-w-none">
  @if (user$ | async; as user) {
    <div class="space-y-4 portrait:space-y-0">
      <!-- Pending Approval State -->
      @if (!isLoading && (userStatus?.role === 'pending' || userStatus?.status === 'pending')) {
        <app-dashboard-pending [user]="user$ | async" (logout)="logout()"></app-dashboard-pending>
      }

      <!-- Loading State -->
      @if (isLoading) {
        <div class="p-12 flex flex-col items-center justify-center text-gray-400 animate-fade-in">
          <svg
            class="animate-spin h-10 w-10 text-emerald-500 mb-4"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <span class="animate-pulse">{{ t('dashboard.loading.verifying') }}</span>
        </div>
      }

      <!-- Super Admin Redirect Fallback -->
      @if (!isLoading && userStatus?.role === 'superadmin') {
        <app-dashboard-super-admin></app-dashboard-super-admin>
      }

      <!-- Active Dashboard -->
      @if (!isLoading && !isPendingApproval && userStatus?.role !== 'new' && userStatus?.role !== 'superadmin') {
        <div
          class="p-6 bg-gray-900/80 backdrop-blur-md rounded-2xl border border-gray-700 shadow-xl animate-fade-in portrait:rounded-none portrait:border-x-0"
        >
          <h2 class="text-2xl font-bold mb-4 text-emerald-400" data-testid="admin-controls">
            {{ t('dashboard.controls.title') }}
          </h2>
          <p class="mb-4 text-gray-300" i18n="@@dashboard.welcome">
            Willkommen, <span class="font-bold text-white">{{ user.displayName }}</span
            >!
          </p>

          <app-dashboard-create-game
            [isCreatingGame]="isCreatingGame"
            (createGame)="onGameCreate($event)"
            (playersChange)="onPlayersChange()"
          ></app-dashboard-create-game>

          @if (createdGame) {
            <div
              class="mb-8 p-4 bg-emerald-900/40 border border-emerald-500/50 rounded-lg animate-pulse-once portrait:rounded-none portrait:border-x-0"
            >
              <h3 class="text-lg font-bold text-emerald-400 mb-2">{{ t('dashboard.created.title') }}</h3>
              <div class="grid grid-cols-1 gap-4 text-sm">
                <div>
                  <span class="text-gray-400 block">{{ t('dashboard.created.id') }}</span>
                  <span class="font-mono text-white select-all text-lg" data-testid="created-game-id">{{
                    createdGame.id
                  }}</span>
                </div>
              </div>
            </div>
          }

          <app-dashboard-game-list
            [games]="games"
            [showTrash]="showTrash"
            [selectedGameIds]="selectedGameIds"
            [isRestoring]="isRestoring"
            [isDeleting]="isDeleting"
            [isLoadingGames]="isLoadingGames"
            [loadingError]="loadingError"
            [expandedGameId]="expandedGameId"
            [totalGames]="totalGames"
            [currentPage]="currentPage"
            [totalPages]="totalPages"
            [pageSize]="pageSize"
            [aiLevel]="newGameConfig.aiLevel"
            (toggleTrashView)="toggleTrashView()"
            (loadGames)="loadGames()"
            (restoreSelected)="restoreSelected()"
            (deleteSelected)="deleteSelected()"
            (toggleSelectAll)="toggleSelectAll($event)"
            (toggleSelection)="toggleSelection($event)"
            (toggleExpand)="toggleExpand($event)"
            (shareGame)="shareGame($event)"
            (restoreGame)="restoreGame($event)"
            (deleteGame)="deleteGame($event)"
            (prevPage)="prevPage()"
            (nextPage)="nextPage()"
            (convertPlayer)="convertPlayer($event.game, $event.slot)"
            (loginAsPlayer)="loginAsPlayer($event.gameId, $event.password)"
            (copyLoginUrl)="copyLoginUrl($event.gameId, $event.password)"
            (generateQrCode)="generateQrCode($event.gameId, $event.playerNumber, $event.password)"
            (sharePlayer)="sharePlayer($event.game, $event.slot)"
            (openFinance)="openFinance($event.game, $event.slot)"
            (printAllQrCodes)="printAllQrCodes($event)"
            (updateDeadline)="onUpdateDeadline($event)"
          ></app-dashboard-game-list>
        </div>
      }

      <!-- QR Overlay -->
      @if (qrCodeUrl) {
        <app-qr-overlay [qrCodeUrl]="qrCodeUrl" [qrCodePlayer]="qrCodePlayer" (closeModal)="closeQr()"></app-qr-overlay>
      }

      <!-- Delete Confirmation Modal -->
      @if (gameToDelete || isDeletingSelected) {
        <app-dashboard-delete-modal
          [gameToDelete]="gameToDelete"
          [isDeletingSelected]="isDeletingSelected"
          [selectedCount]="selectedGameIds.size"
          [showTrash]="showTrash"
          [isDeleting]="isDeleting"
          (closeModal)="cancelDelete()"
          (confirm)="confirmDelete($event)"
        ></app-dashboard-delete-modal>
      }

      <!-- Error Modal -->
      @if (errorMessage) {
        <app-dashboard-error-modal
          [errorMessage]="errorMessage"
          (closeModal)="closeError()"
        ></app-dashboard-error-modal>
      }

      <!-- Finance View Modal -->
      <app-dashboard-finance-modal
        [showFinanceModal]="showFinanceModal"
        [selectedFinanceGame]="selectedFinanceGame"
        [selectedFinancePlayer]="selectedFinancePlayer"
        (closeModal)="closeFinance()"
      ></app-dashboard-finance-modal>
    </div>
  }

  <!-- Login State (If no user) -->
  @if ((user$ | async) === null) {
    <div class="flex flex-col items-start gap-4">
      <p>{{ t('dashboard.login.msg') }}</p>
      <button
        (click)="login()"
        class="px-6 py-2 bg-blue-600 rounded flex items-center gap-2 hover:bg-blue-700 transition"
      >
        {{ t('dashboard.login.btn') }}
      </button>
    </div>
  }
</div>

<!-- Print Only: All QR Codes Grid -->
<div class="print-only p-8 bg-white min-h-screen">
  <div class="grid grid-cols-2 gap-8">
    <div
      *ngFor="let item of allQrCodes"
      class="border-2 border-dashed border-gray-300 p-8 flex flex-col items-center gap-4 break-inside-avoid"
    >
      <h2 class="text-3xl font-bold text-black border-b-2 border-black pb-2 mb-2 w-full text-center">
        {{ item.name }}
      </h2>
      <img [src]="item.qrData" class="w-64 h-64" />
      <div class="mt-4 p-2 bg-gray-100 rounded text-[10px] text-gray-800 font-mono text-center w-full break-all">
        {{ item.url }}
      </div>
      <p class="text-[10px] text-gray-500 mt-2 uppercase tracking-widest">SOIL GAME ACCESS</p>
    </div>
  </div>
</div>
