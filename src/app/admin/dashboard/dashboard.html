<div class="min-h-screen bg-gray-900 text-white font-sans no-print relative overflow-x-hidden">
  <!-- Background Image -->
  <div class="fixed inset-0 h-screen w-screen z-0 pointer-events-none">
    <picture>
      <source srcset="assets/images/bauernhof-portrait-dunkel.webp" media="(orientation: portrait)" />
      <img
        src="assets/images/bauernhof-landscape-dunkel.webp"
        alt=""
        fetchpriority="high"
        class="w-full h-full object-cover portrait:object-center landscape:object-center"
      />
    </picture>
  </div>

  <div class="relative z-10">
    <app-dashboard-hud [user]="user$ | async" [userStatus]="userStatus" (logout)="logout()"></app-dashboard-hud>

    <!-- Main Content -->
    <main class="pt-16 px-4 max-w-4xl mx-auto flex flex-col gap-6 portrait:px-0 portrait:max-w-none pb-12">
      @if (user$ | async; as user) {
        <div class="space-y-6">
          <!-- Pending Approval State -->
          @if (!isLoading && (userStatus?.role === 'pending' || userStatus?.status === 'pending')) {
            <app-dashboard-pending [user]="user$ | async" (logout)="logout()"></app-dashboard-pending>
          }

          <!-- Loading State -->
          @if (isLoading) {
            <div class="p-12 bg-gray-900/80 backdrop-blur-md rounded-3xl border border-gray-700 shadow-2xl flex flex-col items-center justify-center text-gray-400 animate-fade-in portrait:rounded-none">
              <svg
                class="animate-spin h-10 w-10 text-emerald-500 mb-4"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span class="animate-pulse">{{ t('dashboard.loading.verifying') }}</span>
            </div>
          }

          <!-- Super Admin Redirect Fallback -->
          @if (!isLoading && userStatus?.role === 'superadmin') {
            <app-dashboard-super-admin></app-dashboard-super-admin>
          }

          <!-- Active Dashboard -->
          @if (!isLoading && !isPendingApproval && userStatus?.role !== 'new' && userStatus?.role !== 'superadmin') {
            <!-- Create Game Box (includes Welcome & Feedback) -->
            <div class="bg-gray-900 p-8 rounded-3xl border border-gray-700 shadow-2xl space-y-8 portrait:rounded-none portrait:border-x-0">
              <div class="flex justify-between items-start">
                <div>
                  <h2 class="text-2xl font-bold text-emerald-400" data-testid="admin-controls">
                    {{ t('dashboard.controls.title') }}
                  </h2>
                  <p class="text-gray-300">
                    @if (userStatus?.displayName || userStatus?.firstName || user.email) {
                      <ng-container>
                        Willkommen,
                        <span class="font-bold text-white">{{
                          userStatus?.displayName ||
                            (userStatus?.firstName ? userStatus!.firstName + ' ' + userStatus!.lastName : user.email)
                        }}</span
                        >!
                      </ng-container>
                    } @else {
                      <ng-container>
                        Willkommen!
                      </ng-container>
                    }
                  </p>
                </div>
                <button
                  (click)="showFeedbackModal = true"
                  class="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 hover:text-white rounded-xl border border-gray-600 transition shadow-lg"
                >
                  <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    />
                  </svg>
                  <span>Feedback</span>
                </button>
              </div>

              <app-dashboard-create-game
                [isCreatingGame]="isCreatingGame"
                [isGuest]="(user$ | async)?.isAnonymous ?? false"
                (createGame)="onGameCreate($event)"
                (playersChange)="onPlayersChange()"
              ></app-dashboard-create-game>

              @if (createdGame) {
                <div
                  class="mt-6 p-6 bg-emerald-900 border border-emerald-500/50 rounded-2xl animate-pulse-once"
                >
                  <h3 class="text-lg font-bold text-emerald-400 mb-2">{{ t('dashboard.created.title') }}</h3>
                  <div class="grid grid-cols-1 gap-4 text-sm">
                    <div>
                      <span class="text-gray-400 block">{{ t('dashboard.created.id') }}</span>
                      <span class="font-mono text-white select-all text-lg" data-testid="created-game-id">{{
                        createdGame.id
                      }}</span>
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- Join Game Box -->
            <div class="bg-gray-900 p-8 rounded-3xl border border-gray-700 shadow-2xl portrait:rounded-none portrait:border-x-0">
              <app-dashboard-join-game
                (joinGame)="onJoinGame($event)"
              ></app-dashboard-join-game>
            </div>

            <!-- List Games Box -->
            <div class="bg-gray-900 p-8 rounded-3xl border border-gray-700 shadow-2xl portrait:rounded-none portrait:border-x-0">
              <app-dashboard-game-list
                [games]="games"
                [showTrash]="showTrash"
                [selectedGameIds]="selectedGameIds"
                [isRestoring]="isRestoring"
                [isDeleting]="isDeleting"
                [isLoadingGames]="isLoadingGames"
                [loadingError]="loadingError"
                [expandedGameId]="expandedGameId"
                [totalGames]="totalGames"
                [currentPage]="currentPage"
                [totalPages]="totalPages"
                [pageSize]="pageSize"
                [aiLevel]="newGameConfig.aiLevel"
                (toggleTrashView)="toggleTrashView()"
                (loadGames)="loadGames()"
                (restoreSelected)="restoreSelected()"
                (deleteSelected)="deleteSelected()"
                (toggleSelectAll)="toggleSelectAll($event)"
                (toggleSelection)="toggleSelection($event)"
                (toggleExpand)="toggleExpand($event)"
                (shareGame)="shareGame($event)"
                (restoreGame)="restoreGame($event)"
                (deleteGame)="deleteGame($event)"
                (prevPage)="prevPage()"
                (nextPage)="nextPage()"
                (convertPlayer)="convertPlayer($event.game, $event.slot)"
                (loginAsPlayer)="loginAsPlayer($event.gameId, $event.password)"
                (generateQrCode)="generateQrCode($event.gameId, $event.playerNumber, $event.password)"
                (sharePlayer)="sharePlayer($event.game, $event.slot)"
                (printAllQrCodes)="printAllQrCodes($event)"
                (updateDeadline)="onUpdateDeadline($event)"
              ></app-dashboard-game-list>
            </div>

            <!-- Teacher Guide Box -->
            <app-dashboard-teacher-guide></app-dashboard-teacher-guide>
          }
        </div>
      }
    </main>

    <!-- Overlays & Modals -->
    <!-- QR Overlay -->
    @if (qrCodeUrl) {
      <app-qr-overlay [qrCodeUrl]="qrCodeUrl" [qrCodePlayer]="qrCodePlayer" (closeModal)="closeQr()"></app-qr-overlay>
    }

    <!-- Delete Confirmation Modal -->
    @if (gameToDelete || isDeletingSelected) {
      <app-dashboard-delete-modal
        [gameToDelete]="gameToDelete"
        [isDeletingSelected]="isDeletingSelected"
        [selectedCount]="selectedGameIds.size"
        [showTrash]="showTrash"
        [isDeleting]="isDeleting"
        (closeModal)="cancelDelete()"
        (confirm)="confirmDelete($event)"
      ></app-dashboard-delete-modal>
    }

    <!-- Error Modal -->
    @if (errorMessage) {
      <app-dashboard-error-modal
        [errorMessage]="errorMessage"
        (closeModal)="closeError()"
      ></app-dashboard-error-modal>
    }

    <!-- Finance View Modal -->
    <app-dashboard-finance-modal
      [showFinanceModal]="showFinanceModal"
      [selectedFinanceGame]="selectedFinanceGame"
      [selectedFinancePlayer]="selectedFinancePlayer"
      (closeModal)="closeFinance()"
    ></app-dashboard-finance-modal>

    <!-- Feedback Modal -->
    @if (showFeedbackModal) {
      <app-feedback-modal
        (closeModal)="onFeedbackClose()"
        (feedbackSubmit)="onFeedbackSubmit($event)"
      ></app-feedback-modal>
    }
  </div>
</div>

<!-- Print Only: All QR Codes Grid -->
<div class="print-only p-8 bg-white min-h-screen">
  <div class="grid grid-cols-2 gap-8">
    @for (item of allQrCodes; track item.name) {
      <div class="border-2 border-dashed border-gray-300 p-8 flex flex-col items-center gap-4 break-inside-avoid">
        <h2 class="text-3xl font-bold text-black border-b-2 border-black pb-2 mb-2 w-full text-center">
          {{ item.name }}
        </h2>
        <img [src]="item.qrData" class="w-64 h-64" [alt]="'QR Code for access to ' + item.name" />
        <div class="mt-4 p-2 bg-gray-100 rounded text-[10px] text-gray-800 font-mono text-center w-full break-all">
          {{ item.url }}
        </div>
        <p class="text-[10px] text-gray-500 mt-2 uppercase tracking-widest">SOIL GAME ACCESS</p>
      </div>
    }
  </div>
</div>